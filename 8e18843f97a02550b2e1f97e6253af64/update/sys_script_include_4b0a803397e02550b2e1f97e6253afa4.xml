<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>public</access>
        <active>true</active>
        <api_name>x_912467_klf_todo.TaskManager</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>TaskManager</name>
        <script><![CDATA[/**
 * Object for managing todo tasks
 * @class TaskManagerClass
 */
const TaskManager = (function() {
    /**
     * Values for x_912467_klf_todo_task.status field
     */
    const STATUS = {
        DRAFT: 'draft',
        SUBMITTED: 'submitted',
        IN_PROGRESS: 'in_progress',
        CLOSED: 'closed',
        CANCELED: 'canceled'
    };

    const groupUtils = x_912467_klf.GroupUtils;

    class TaskManager {

        /**
         * Called by business rule when task is assigned to a user
         * @param {GlideRecord} task x_912467_klf_todo_task 
         */
        onAssigned(task) {
            // set assigned fields
            task.assigned_to = Authenticated.getUserSysId();

            if(task.status == STATUS.SUBMITTED) {
                task.status = STATUS.IN_PROGRESS;
            }
        }

        /**
         * Called by business rule when task status changes to closed
         * Need to set closed fields
         * @param {GlideRecord} task x_912467_klf_todo_task closed task
         */
        onClosed(task) {
            task.closed_by = Authenticated.getUserSysId();
            task.closed_on = new GlideDateTime();
        }

        /**
         * Called by business rule when task status changes
         * @param {GlideRecord} task x_912467_klf_todo_task
         */
        onStatusChange(task) {
            // Need to update active field whenever status changes
            this.updateActive(task);
        }

        /**
         * Update active field on task
         * When task status reaches an inactive status set the active field to false
         * Inactive statuses are closed, canceled
         */
        updateActive(task) {
            if(task.status == STATUS.CLOSED || task.status == STATUS.CANCELED) {
                task.active = false;
            }
        }

        /**
         * Returns true if user can write to the task
         * User can write to the task if the task is a new record
         * if the user is an admin always return true
         * if the task is inactive return false if not admin
         * if the user is the creator and the task is in draft status
         * if the user is the original submitter of the task and the task is in draft status
         * if the user is the assignee of the task and the task is in submitted or in progress status
         * if the user is a member of the task's assigned group and the task is in submitted or in progress status
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         */
        canWrite(task) {
            if(Authenticated.isAdmin) {
                return true;
            }

            // eslint complains this isn't a boolean, but i know it is
            // eslint-disable-next-line
            if(!Boolean(task.active)) {
                return false;
            }

            return task.isNewRecord() ||
                (this.isSubmitter(task) && task.status == STATUS.DRAFT) ||
                (this.isCreator(task) && task.status == STATUS.DRAFT) ||
                (this.isAssigned(task) && (task.status == STATUS.SUBMITTED || task.status == STATUS.IN_PROGRESS)) ||
                (this.isInAssignedGroup(task) && (task.status == STATUS.SUBMITTED || task.status == STATUS.IN_PROGRESS));
        }

        /**
         * Returns true if user can read the task
         * if task is new record
         * if the user is the creator
         * if the user is the original submitter of the task
         * if the user is the assignee of the task
         * if the user is a member of the task's group 
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         * @returns {boolean} True if user can read the task
         */
        canRead(task) {
            return task.isNewRecord() ||
                this.isSubmitter(task) ||
                this.isCreator(task) ||
                this.isAssigned(task) ||
                this.isInAssignedGroup(task);
        }

        /**
         * Returns true if user is in assigned group
         * @param {GlideRecord} task
         * @returns {boolean}
         */
        isInAssignedGroup(task) {
            return Authenticated.isMemberOf(task.assigned_group);
        }

        /**
         * Returns true if user is assigned to the task
         * @param {GlideRecord} task
         * @returns {boolean}
         */
        isAssigned(task) {
            return task.assigned_to == Authenticated.getUserSysId();
        }

        /**
         * Returns true if user opened the task
         * @param {GlideRecord} task
         * @returns {boolean}
         */
        isCreator(task) {
            return task.opened_by == Authenticated.getUserSysId();
        }

        /**
         * Returns true if the user is the original submitter of the task
         * @param {GlideRecord} task 
         * @returns {boolean}
         */
        isSubmitter(task) {
            return task.submitted_by == Authenticated.getUserSysId();
        }

        /**
         * Returns true if user has access to "Close" UI Action
         * User can close if the task is in progress or submitted
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         * @returns {boolean} True if user has access to "Close" UI Action
         */
        showClose(task) {
            return this.canWrite(task) && 
                (task.status == STATUS.IN_PROGRESS || task.status == STATUS.SUBMITTED);
        }

        /**
         * Closes the task by setting the status to closed
         * @param {GlideRecord} task x_912467_klf_todo_task to close
         */
        close(task) {
            task.status = STATUS.CLOSED;
            task.update();
        }

        /**
         * Called by business rule when task is submitted
         * @param {GlideRecord} task x_912467_klf_todo_task submitted task
         */
        onSubmit(task) {
            // set submitted fields
            task.submitted_by = Authenticated.getUserSysId();
            task.submitted_on = new GlideDateTime();

            // set the default assigned group
            task.assigned_group = this.getDefaultAssignedGroup();
        }

        /**
         * Returns the default assigned group sys_id for the task
         * getting it from a system property
         * @returns {string} sys_id of the default assigned group
         */
        getDefaultAssignedGroup() {
            const groupName = gs.getProperty('x_912467_klf_todo.default_assigned_group');
            if(!groupName) {
                const error = 'Default assigned group not set in system property x_912467_klf_todo.default_assigned_group';
                gs.error(error);
                gs.addErrorMessage(error);
            }

            const defaultGroup = groupUtils.getGroupByName(groupName);

            return defaultGroup ? defaultGroup.getUniqueValue() : '';
        }


        /**
         * Returns true if user has access to "Submit" UI Action
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         * @returns {boolean} True if user has access to "Submit" UI Action
         */
        showSubmit(task) {
            // Initially status will be empty so show the action
            return task.status.nil() || task.status == STATUS.DRAFT;
        }

        /**
         * UI Action to submit a task. This initiates
         * the first state in the workflow.
         * @param {GlideRecord} task x_912467_klf_todo_task to submit
         */
        submit(task) {
            task.status = STATUS.SUBMITTED;
            task.update();
        }

        /**
         * Returns true if user has access to "Save" UI Action
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         * @returns {boolean} True if user has access to "Save" UI Action
         */
        showSave(task) {
            return this.canWrite(task) && 
                (task.status == STATUS.SUBMITTED || task.status == STATUS.IN_PROGRESS);
        }

        /**
         * UI Action to save a task. This saves the task
         */
        save(task) {
            task.update();
        }

        /**
         * Returns true if user has access to "Save as Draft" UI Action
         * @param {GlideRecord} task x_912467_klf_todo_task to check
         * @returns {boolean} True if user has access to "Save as Draft" UI Action
         */
        showSaveAsDraft(task) {
            // Initially status will be empty so show the action
            return task.status.nil() || task.status == STATUS.DRAFT;
        }

        /**
         * UI Action to save a task as draft. When task is
         * saved as draft, it is not submitted to the workflow.
         * @param {GlideRecord} task x_912467_klf_todo_task to save as draft
         */
        saveAsDraft(task) {
            task.status = STATUS.DRAFT;
            task.update();
        }

    }

    return new TaskManager();
})();]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2023-01-29 00:58:02</sys_created_on>
        <sys_id>4b0a803397e02550b2e1f97e6253afa4</sys_id>
        <sys_name>TaskManager</sys_name>
        <sys_package display_value="KLF Todo" source="x_912467_klf_todo">8e18843f97a02550b2e1f97e6253af64</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="KLF Todo">8e18843f97a02550b2e1f97e6253af64</sys_scope>
        <sys_update_name>sys_script_include_4b0a803397e02550b2e1f97e6253afa4</sys_update_name>
    </sys_script_include>
</record_update>
